#! /usr/bin/env bash

#=========================================================================#
#                             checksummarize                              #
#                                                                         #
# Author: nic                                                             #
# Date: 2017-Feb-16                                                       #
#                                                                         #
# Generate a script that will perform checksums for the files recursively #
# below this directory.                                                   #
#                                                                         #
# Usage                                                                   #
#     checksummarize [path]                                               #
#=========================================================================#

set -e
set -u

function usage(){
    grep "^#.*#$" $0
}

function errxit(){
    [ $# -gt 0 ] && echo "Error: $1"
    echo "Re-run with -h for help" >&2
    exit 1
}

while getopts "h" opt; do
    case $opt in
        h)
            usage
            exit 0
            ;;
        \?)
            errxit
            ;;
    esac
done
shift $(($OPTIND -1))

DIR="."
[ $# -gt 0 ] && DIR="$1"

[ -d "$DIR" ] || errxit "Cannot create checksums for a non-directory \"$DIR\""
[ -f "$DIR/CHECKSUM" ] && errxit "A checksum file already exists at \"$DIR/CHECKSUM\""

trap "popd > /dev/null" EXIT
pushd "$DIR" > /dev/null

echo "#! /usr/bin/env bash" > CHECKSUM
echo "trap \"popd > /dev/null\" EXIT" >> CHECKSUM
echo "pushd \$(dirname \$0) > /dev/null" >> CHECKSUM
echo "cat << SHA_256_SUM_EOF | sha256sum -c | grep -v \"OK$\"" >> CHECKSUM
find . -type f | grep -v "^\./CHECKSUM$" | sort | xargs -d"\n" sha256sum | tee -a CHECKSUM
echo "SHA_256_SUM_EOF" >> CHECKSUM
echo "if [ \"\$?\" == \"0\" ]; then" >> CHECKSUM
echo "    exit 1" >> CHECKSUM
echo "else" >> CHECKSUM
echo "    echo \"Success\"" >> CHECKSUM
echo "fi" >> CHECKSUM
chmod a+x CHECKSUM

